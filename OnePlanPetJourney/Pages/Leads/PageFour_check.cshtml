@page "{id:int}"
@model OnePlanPetJourney.Pages.Leads.PageFourModel

@{
    ViewData["Title"] = "Set Pet Plans";
    ViewData["CurrentStep"] = 4;
}

@if (TempData["Message"] is string msg)
{
    <div class="alert alert-success">@msg</div>
}


<div class="row">
    <div class=" col-md-8 offset-md-2 mb-3">
            <h1>
         Select your plan and optional add-ons
            </h1>
    </div>
</div>


<div class="row">
  <div class="col-md-10 offset-md-1">
    <form method="post" id="plan-selection" novalidate>
      @Html.AntiForgeryToken()
      <input asp-for="Input.LeadId" type="hidden" />
      <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

      <!-- ===================== -->
      <!-- PASS 1: PLAN SELECTION (all pets) -->
      <!-- ===================== -->
      @for (int i = 0; i < Model.Input.Items.Count; i++)
      {
          var pet = Model.Input.Items[i];
          var petKey = $"pet_{pet.PetId}";
          var expandedId = $"{petKey}_expanded";

          <div class="card plan-wrapper-card mb-3">
          <div class="card-header">
            <div class="row align-items-center">
              <div class="petname col-12 col-md-6 text-start">
                Choose a plan for: @pet.Name
              </div>

              <div class="col-12 col-md-6 delete-actions d-flex justify-content-start justify-content-md-end align-items-center gap-2">
                <span class="delete-text">Delete</span>
                <!-- If you're on Bootstrap 5, use btn-close (not .close) -->
                <button type="button" class="btn-close close" aria-label="Close"></button>
              </div>
            </div>
          </div>

            <div class="card-body">
              <input asp-for="Input.Items[i].PetId" type="hidden" />

              <div class="row plan-row g-2">
                <div class="col-md-4 custom-column col-xl-2 d-flex align-items-center">
                  @if (pet.IsDog)
                  {
                      <img src="~/images/icon-dog.png" alt="Dog" class="pet-icon" />
                  }
                  else
                  {
                      <img src="~/images/icon-cat.png" alt="Cat" class="pet-icon" />
                  }
                </div>

                @{ var planIndex = 1; }
                @foreach (var plan in Model.Plans)
                {
                    var inputId    = $"{petKey}_plan_{plan.Value}";
                    var templateId = $"plan_template_{plan.Value}";
                    var planId     = int.Parse(plan.Value);
                    var price      = Model.PlanPrices.TryGetValue(planId, out var p) ? p : 0;

                    string tooltip = plan.Text switch
                    {
                        "Super"    => "Super comprehensive cover for vet visits and routine care, as well as cover for unexpected accidents and illnesses that require hospital admission PLUS MORE",
                        "Classic"  => "Comprehensive day-to-day cover for vet visits and routine care, and cover for unexpected accidents and illnesses that require hospital admission PLUS MORE",
                        "Hospital" => "Cover for unexpected accidents and illnesses that require hospital admission.",
                        "Accident" => "Cover for unexpected accidents that require hospital admission.",
                        "Primary"  => "Small day-to-day cover for vet visits and cover for unexpected accidents and illnesses that require hospital admission.",
                        _ => "Plan details"
                    };

                    <div class="col-md-4 custom-column col-xl-2 plan-col-@planIndex">
                      <div class="border rounded p-3 h-100 plan-card"
                           role="button"
                           tabindex="0"
                           onclick="selectPlan('@inputId')"
                           onkeydown="if (event.key === 'Enter' || event.key === ' ') { selectPlan('@inputId'); event.preventDefault(); }">

                        <div class="text-center plan-content-wapper">
                          <h3 class="text-center">@plan.Text</h3>

                          <!-- IMPORTANT: Use asp-for to ensure a unique group name per pet -->
                          <input asp-for="Input.Items[i].PlanType"
                                 type="radio"
                                 id="@inputId"
                                 value="@plan.Value"
                                 class="form-check-input me-2" />

                          <h5>R @price</h5>
                          <h5>Per Month</h5>
                           <p>
                        
                           </p>
                            <a href="#" class="toggle-link" role="button"
                                aria-expanded="false" aria-controls="toggleContent_@inputId">Show details</a>

                              <!-- Content to show/hide. Give it a unique ID -->
                             <div id="toggleContent_@inputId" class="toggleContent">
                                <div class="text-start add-on-checks">
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault_@inputId" checked>
                                    <label class="form-check-label" for="flexCheckDefault_@inputId">
                                      Excess Buster
                                      <i class="fas fa-info-circle" 
                                        data-bs-toggle="tooltip" 
                                        data-bs-title="Pay zero excess on eligible admissions."
                                        style="cursor: pointer;"></i>
                                    </label>
                                  </div>
                                  
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="flexCheckChecked1_@inputId" checked>
                                    <label class="form-check-label" for="flexCheckChecked1_@inputId">
                                      Pet Med Booster
                                      <i class="fas fa-info-circle" 
                                        data-bs-toggle="tooltip" 
                                        data-bs-title="Add routine care & waive excess."
                                        style="cursor: pointer;"></i>
                                    </label>
                                  </div>
                                  
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="flexCheckChecked2_@inputId" checked>
                                    <label class="form-check-label" for="flexCheckChecked2_@inputId">
                                      Diagnostic Booster
                                      <i class="fas fa-info-circle" 
                                        data-bs-toggle="tooltip" 
                                        data-bs-title="Add diagnostic cover"
                                        style="cursor: pointer;"></i>
                                    </label>
                                  </div>
                                </div>
                              </div>
                        


                          <button type="button"
                                  class="btn plan-tooltip-btn"
                                  data-bs-toggle="tooltip"
                                  data-bs-title="@tooltip"
                                  onclick="event.stopPropagation()"
                                  aria-label="Plan info">
                            <svg width="8" height="11" viewBox="0 0 8 11" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M5.16221 0.652344C6.56221 0.652344 7.69971 1.79328 7.69971 3.22505C7.69971 4.20939 7.15283 5.10425 6.29971 5.55167L4.54971 6.60313V7.07293C4.54971 7.47561 4.22158 7.78881 3.84971 7.78881C3.45596 7.78881 3.14971 7.47561 3.14971 7.07293V6.17807C3.14971 5.93199 3.25908 5.70827 3.47783 5.57404L5.62158 4.29888C6.05908 4.07516 6.29971 3.67248 6.29971 3.22505C6.29971 2.59865 5.77471 2.08411 5.16221 2.08411H2.79971C2.40596 2.08411 2.09971 2.39731 2.09971 2.79999C2.09971 3.15794 1.77158 3.49351 1.39971 3.49351C1.00596 3.49351 0.699707 3.18031 0.699707 2.79999C0.699707 1.61431 1.64033 0.652344 2.79971 0.652344H5.16221ZM3.84971 8.86263C4.33096 8.86263 4.72471 9.28769 4.72471 9.75749C4.72471 10.2497 4.33096 10.6523 3.84971 10.6523C3.34658 10.6523 2.97471 10.272 2.97471 9.75749C2.97471 9.26532 3.34658 8.86263 3.84971 8.86263Z" fill="white"/>
                            </svg>
                          </button>
                        </div>
                       
                        <div class="mt-2">
                          <button class="btn btn-read-more p-0 toggle-read"
                                  type="button"
                                  onclick="togglePlan(this,'@inputId','@expandedId','@templateId'); event.stopPropagation();">
                            <span class="label">Read more</span>
                            <span class="icon"><img src="~/images/btn-chevron.png" alt=""></span>
                          </button>
                        </div>
                      </div>
                    </div>

                    <div id="@templateId" class="d-none">
                      @if (plan.Text == "Super")       { <partial name="_Super" /> }
                      else if (plan.Text == "Classic") { <partial name="_Classic" /> }
                      else if (plan.Text == "Hospital"){ <partial name="_Hospital" /> }
                      else if (plan.Text == "Accident"){ <partial name="_Accident" /> }
                      else if (plan.Text == "Primary") { <partial name="_Primary" /> }
                      else { <div>No details available.</div> }
                    </div>

                    { planIndex++; }
                }
              </div>

              <div class="row mt-3">
                <div class="col-12">
                  <div id="@expandedId"
                       class="p-3 d-none pet-expanded"
                       data-pet="@petKey">
                    <em>Select a plan and click “Read more” to view details here…</em>
                  </div>
                </div>
              </div>

              <span asp-validation-for="Input.Items[i].PlanType" class="text-danger d-block mt-2"></span>
            </div>
          </div>
      }



      <div class="row mb-5">
  <div class="col-md-8 offset-md-2">
    <h1 class="mb-4">It's time to choose your Paw-fect Plan for your pet(s).</h1>

    @for (int i = 0; i < Model.Input.Items.Count; i++)
    {
      
          var pet = Model.Input.Items[i];
          <div class="premium-price">
            <div class="card  mb-3">
                  <div class="mt-3">
                    <h1 class=" weigt-400 text-center">
                      <span class="weigt-700"><span class="teal">R000pm</span></span>
                    </h1>
                    <p class=" weigt-400 text-center">
                      <span class="weigt-700">@pet.Name on [Plan name]
                    </p>
                    <p class="text-center"><i>
                      This premium includes the <strong>Excess Buster</strong> (never pay excess) and <strong>Pet Med Booster</strong> (add/ double pet med Savings).</i>
                    </p>
              
                  </div>
              </div>
        </div>
      }
@Html.Partial("_addOn")

    <div class="row">
      <div class="col-md-4 offset-md-4 mt-3 mb-md-2">
        <button id="btnSendQuote" type="button" class="btn btn-send-my-quote w-100">
          Send me my quote
        </button>
      </div>
    </div>
  </div>
</div>

      <div class="row">
        <div class="">
          <div class="navigation-container">
            <div class="row">
              <div id="divCallMe" class="col-sm-12 col-md-6 mb-4">
                <button id="btnCallMePopUp"
                        type="button"
                        class="btn btn-block btn-nav-call-me btn-nav btn-nav-properties"
                        data-bs-toggle="modal"
                        data-bs-target="#CallMePopUp">
                  <span><img src="~/images/icon-call-me.png" alt=""></span>&nbsp;&nbsp;Call me rather&nbsp;&nbsp;
                </button>
              </div>

              <div id="divPrevious" class="col-sm-12 col-md-3 mb-4">
                <button id="btnPrevious"
                        type="button"
                        class="btn btn-block btn-nav-previous btn-nav btn-nav-properties"
                        onclick="PrevStepThree()">
                  <span><img src="~/images/icon-chev-left.png" alt=""></span>&nbsp;&nbsp;Previous&nbsp;&nbsp;
                </button>
              </div>

              <div id="divContinue" class="col-sm-12 col-md-3 mb-4">
                <button id="btnContinue"
                        type="submit"
                        class="btn btn-block btn-nav-continue btn-nav btn-nav-properties">
                  <span><img src="~/images/icon-chev-right.png" alt=""></span>&nbsp;&nbsp;Continue&nbsp;&nbsp;
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </form>
  </div>
</div>

@section Scripts {
<script>
// --- helpers ---
function setToggleState(btn, isOpen) {
  if (!btn) return;
  const labelEl = btn.querySelector('.label');
  if (labelEl) labelEl.textContent = isOpen ? 'Read less' : 'Read more';
  btn.classList.toggle('open', !!isOpen);
}

function closeAllExpanded() {
  document.querySelectorAll('.pet-expanded').forEach(function (el) {
    el.classList.add('d-none');
    el.setAttribute('aria-hidden', 'true');
    el.removeAttribute('data-current-template');
  });
}

function resetButtonsInWrapper(wrapper) {
  if (!wrapper) return;
  wrapper.querySelectorAll('.btn-read-more').forEach(function (b) { setToggleState(b, false); });
}

function openPlanDetails(container, templateId) {
  const template = document.getElementById(templateId);
  if (!container || !template) return;

  // one open globally at a time (keeps your existing behavior)
  closeAllExpanded();

  container.innerHTML = template.innerHTML;
  container.classList.remove('d-none');
  container.setAttribute('aria-hidden', 'false');
  container.setAttribute('data-current-template', templateId);

  container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function closePlanDetails(container, btnToMarkClosed) {
  if (!container) return;
  container.classList.add('d-none');
  container.setAttribute('aria-hidden', 'true');
  container.removeAttribute('data-current-template');
  setToggleState(btnToMarkClosed, false);
}

// --- select plan by clicking the card ---
function selectPlan(inputId) {
  const radio = document.getElementById(inputId);
  if (!radio || radio.disabled) return;

  // check the radio
  radio.checked = true;

  // Limit visual selection to the same pet's wrapper
  const petWrapper = radio.closest('.plan-wrapper-card');
  if (petWrapper) {
    petWrapper.querySelectorAll('.plan-card.is-selected').forEach(function (el) {
      el.classList.remove('is-selected');
    });
  }

  const card = radio.closest('.plan-card');
  if (card) card.classList.add('is-selected');

  try { radio.dispatchEvent(new Event('change', { bubbles: true })); } catch {}

  // Auto-expand details for this selected plan and update the matching button label
  // inputId shape: `${petKey}_plan_${planValue}`
  const parts = inputId.split('_plan_');
  if (parts.length === 2) {
    const planValue  = parts[1];
    const templateId = 'plan_template_' + planValue;

    const container  = petWrapper ? petWrapper.querySelector('.pet-expanded') : null;

    // reset all read-more buttons in this pet wrapper first
    resetButtonsInWrapper(petWrapper);

    // mark THIS card's read-more button as open
    const btnForThisCard = card ? card.querySelector('.btn-read-more') : null;
    setToggleState(btnForThisCard, true);

    openPlanDetails(container, templateId);
  }
}

// --- "Read more / Read less" button behavior ---
function togglePlan(btn, inputId, containerId, templateId) {
  const radio     = document.getElementById(inputId);
  const container = document.getElementById(containerId);
  const template  = document.getElementById(templateId);
  if (!container || !template) return;

  const current = container.getAttribute('data-current-template');
  const isOpen  = !container.classList.contains('d-none');

  // Clicking "Read less" -> collapse only this container
  if (current === templateId && isOpen) {
    closePlanDetails(container, btn);
    return;
  }

  // Ensure the plan is selected when opening via "Read more"
  if (radio) {
    radio.checked = true;
    try { radio.dispatchEvent(new Event('change', { bubbles: true })); } catch {}
  }

  // Reset labels only within this pet's wrapper, then open and mark this one "Read less"
  const petWrapper = container.closest('.plan-wrapper-card');
  resetButtonsInWrapper(petWrapper);
  setToggleState(btn, true);

  openPlanDetails(container, templateId);
}

// --- add-on selection (unchanged) ---
function toggleAddOn(inputId) {
  const rb = document.getElementById(inputId);
  if (!rb) return;
  rb.checked = true;

  const groupName = rb.name;
  document.querySelectorAll('input[type="radio"][name="' + groupName + '"]').forEach(function (r) {
    const c = document.getElementById('card_' + r.id);
    if (c) c.classList.remove('is-selected');
  });

  const card = document.getElementById('card_' + inputId);
  if (card) card.classList.add('is-selected');

  try { rb.dispatchEvent(new Event('change', { bubbles: true })); } catch {}
}

// Init tooltips
document.addEventListener('DOMContentLoaded', function () {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(function (el) { new bootstrap.Tooltip(el); });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Select all toggle links inside plan cards
    document.querySelectorAll('.toggle-link').forEach(function(link) {
        const card = link.closest('.plan-card');
        if (!card) return;
        
        // Find the toggleContent within this card using the class
        const content = card.querySelector('.toggleContent');
        if (!content) return;
        
        // Hide content initially
        content.classList.add('d-none');
        link.setAttribute('aria-expanded', 'false');
        link.innerHTML = 'Make Cheaper <i class="fas fa-plus"></i>';

        link.addEventListener('click', function(e) {
            e.preventDefault();
            const isExpanded = content.classList.contains('d-none') === false;

            if (isExpanded) {
                content.classList.add('d-none');
                link.setAttribute('aria-expanded', 'false');
                link.innerHTML = 'Make Cheaper  <i class="fas fa-plus"></i>';
            } else {
                content.classList.remove('d-none');
                link.setAttribute('aria-expanded', 'true');
                link.innerHTML = 'Close <i class="fas fa-minus"></i>';
            }
        });
    });
});
</script>


<partial name="_ValidationScriptsPartial" />
}
